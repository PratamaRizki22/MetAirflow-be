generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Master jenis properti (mis: Apartemen, Rumah, Studio).
/// Dibuat terpisah agar bisa dikelola via admin tanpa redeploy.
model PropertyType {
  id          String     @id @default(uuid())
  code        String     @unique
  name        String
  description String?
  icon        String? // Icon URL or icon class name
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  properties  Property[]

  @@map("property_types")
}

/// Master fasilitas/amenitas (mis: AC, Kolam Renang).
model Amenity {
  id         String            @id @default(uuid())
  name       String            @unique
  category   String?
  properties PropertyAmenity[]

  @@map("amenities")
}

/// Akun pengguna (tenant, landlord, admin).
model User {
  id             String    @id @default(uuid())
  email          String    @unique
  firstName      String    @default("")
  lastName       String    @default("")
  name           String // Computed field (firstName + lastName) for backward compatibility
  dateOfBirth    DateTime?
  phone          String?
  profilePicture String? // URL for user's profile picture
  password       String?
  role           Role      @default(USER)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  verifiedAt     DateTime?

  // OAuth IDs
  googleId   String? @unique
  facebookId String? @unique
  appleId    String? @unique
  githubId   String? @unique
  twitterId  String? @unique

  // Roles & Status
  isHost Boolean @default(false) // True if user has activated hosting mode

  // Stripe Integration
  stripeCustomerId String? @unique

  leasesAsLandlord    Lease[]              @relation("LandlordLeases")
  leasesAsTenant      Lease[]              @relation("TenantLeases")
  approvals           ListingApproval[]    @relation("ReviewerApprovals")
  payments            Payment[]
  stripePayments      StripePayment[]      @relation("UserStripePayments")
  properties          Property[]           @relation("OwnerProperties")
  propertyViews       PropertyView[]       @relation("PropertyViews")
  propertyRatings     PropertyRating[]     @relation("PropertyRatings")
  propertyFavorites   PropertyFavorite[]   @relation("PropertyFavorites")
  favoriteCollections FavoriteCollection[] @relation("UserCollections")
  reviews             Review[]             @relation("UserReviews")

  @@map("users")
}

/// Listing properti yang ditawarkan (detail fisik, lokasi, harga).
/// Gambar/Foto disimpan langsung di kolom `images` (array URL).
model Property {
  id           String   @id @default(uuid())
  title        String
  description  String?
  address      String
  city         String
  state        String
  zipCode      String
  country      String   @default("MY")
  price        Decimal  @db.Decimal(12, 2)
  currencyCode String   @default("MYR")
  bedrooms     Int      @default(0)
  bathrooms    Int      @default(0)
  areaSqm      Float?
  furnished    Boolean  @default(false)
  isAvailable  Boolean  @default(true)
  autoApproval Boolean  @default(false)
  /// Kumpulan URL gambar untuk listing ini (urutan = urutan tampilan).
  images       String[] @default([])

  // Informasi lokasi dan geografis
  latitude  Float?
  longitude Float?
  placeId   String?
  geom      Unsupported("geometry")? @map("geom")

  // Informasi developer/proyek (opsional)
  projectName String?
  developer   String?

  // Rental agreement and house rules (mandatory PDFs)
  agreementPdfUrl    String? // URL to rental agreement PDF template
  agreementPublicId  String? // Cloudinary public ID for agreement
  houseRulesPdfUrl   String? // URL to house rules PDF
  houseRulesPublicId String? // Cloudinary public ID for house rules

  // Metadata sistem
  code      String        @unique
  status    ListingStatus @default(PENDING_REVIEW)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relasi
  ownerId        String
  propertyTypeId String

  leases       Lease[]
  approvals    ListingApproval[]
  predictions  PricePrediction[]
  views        PropertyView[]
  ratings      PropertyRating[]
  favorites    PropertyFavorite[]
  reviews      Review[]           @relation("PropertyReviews")
  owner        User               @relation("OwnerProperties", fields: [ownerId], references: [id], onDelete: Cascade)
  propertyType PropertyType       @relation(fields: [propertyTypeId], references: [id])
  amenities    PropertyAmenity[]

  @@index([latitude, longitude])
  @@index([city, state, country])
  @@index([status, isAvailable])
  @@map("properties")
}

/// Tabel pivot N:N antara Property dan Amenity.
model PropertyAmenity {
  propertyId String
  amenityId  String
  amenity    Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@id([propertyId, amenityId])
  @@map("property_amenities")
}

/// Log review listing oleh admin (simple audit trail).
model ListingApproval {
  id         String         @id @default(uuid())
  propertyId String         @unique // One approval per property (latest status)
  reviewerId String? // Admin yang review
  status     ApprovalStatus @default(PENDING)
  notes      String? // Optional rejection reason
  reviewedAt DateTime? // Kapan di-review
  createdAt  DateTime       @default(now())
  property   Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  reviewer   User?          @relation("ReviewerApprovals", fields: [reviewerId], references: [id])

  @@index([status])
  @@map("listing_approvals")
}

/// Kontrak sewa jangka waktu antara landlord dan tenant.
model Lease {
  id              String      @id @default(uuid())
  code            String      @unique @default(cuid())
  startDate       DateTime
  endDate         DateTime
  rentAmount      Decimal     @db.Decimal(12, 2)
  currencyCode    String      @default("MYR")
  securityDeposit Decimal?    @db.Decimal(12, 2)
  status          LeaseStatus @default(PENDING)
  notes           String? // Catatan dari user saat booking
  message         String? // Message to landlord when booking
  hasReview       Boolean     @default(false) // Track if tenant has reviewed

  // Payment tracking
  paymentStatus String  @default("pending") // pending, paid, refunded
  totalPrice    Decimal @default(0) @db.Decimal(12, 2)

  // Approval/rejection tracking
  approvedAt         DateTime?
  rejectedAt         DateTime?
  rejectionReason    String?
  cancelledAt        DateTime?
  cancellationReason String?

  // Digital signature fields
  tenantSignatureUrl String? // URL to tenant's signature image
  signedAgreementUrl String? // URL to final signed agreement PDF
  signedAt           DateTime? // When tenant signed the agreement

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  propertyId     String
  tenantId       String
  landlordId     String
  invoices       Invoice[]
  stripePayments StripePayment[]  @relation("LeaseStripePayments")
  landlord       User             @relation("LandlordLeases", fields: [landlordId], references: [id])
  property       Property         @relation(fields: [propertyId], references: [id])
  tenant         User             @relation("TenantLeases", fields: [tenantId], references: [id])
  agreement      RentalAgreement?
  review         Review? // One-to-one relation with Review

  @@index([propertyId, status])
  @@index([tenantId])
  @@index([landlordId])
  @@index([code])
  @@map("leases")
}

/// Dokumen tagihan untuk lease (sewa/beban lainnya).
model Invoice {
  id           String        @id @default(uuid())
  leaseId      String
  type         InvoiceType   @default(RENT)
  amount       Decimal       @db.Decimal(12, 2)
  currencyCode String        @default("MYR")
  dueDate      DateTime
  status       InvoiceStatus @default(DUE)
  issuedAt     DateTime      @default(now())
  paidAt       DateTime?
  memo         String?
  lease        Lease         @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  payments     Payment[]

  @@index([leaseId, status, dueDate])
  @@map("invoices")
}

/// Pencatatan pembayaran invoice (mendukung cicilan/multi-part).
model Payment {
  id        String        @id @default(uuid())
  invoiceId String
  amount    Decimal       @db.Decimal(12, 2)
  method    PaymentMethod @default(BANK_TRANSFER)
  status    PaymentStatus @default(PENDING)
  paidAt    DateTime?
  txnRef    String?
  createdAt DateTime      @default(now())
  payerId   String?
  invoice   Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payer     User?         @relation(fields: [payerId], references: [id])

  @@index([invoiceId, status])
  @@map("payments")
}

/// Perjanjian sewa (hasil generate PDF) untuk satu lease.
model RentalAgreement {
  id          String   @id @default(uuid())
  leaseId     String   @unique
  pdfUrl      String? // Cloudinary URL
  publicId    String? // Cloudinary public ID untuk delete
  fileName    String? // Nama file untuk display
  fileSize    Int? // Size dalam bytes
  generatedAt DateTime @default(now())
  lease       Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@map("rental_agreements")
}

/// Log prediksi harga (input mentah, harga prediksi, confidence, versi model).
model PricePrediction {
  id             String    @id @default(uuid())
  propertyId     String?
  inputs         Json
  predictedPrice Decimal   @db.Decimal(12, 2)
  confidence     Float
  modelVersion   String
  createdAt      DateTime  @default(now())
  property       Property? @relation(fields: [propertyId], references: [id])

  @@index([propertyId, modelVersion])
  @@map("price_predictions")
}

/// Log views/kunjungan ke detail property untuk analytics dan tracking popularitas.
model PropertyView {
  id         String   @id @default(uuid())
  propertyId String
  userId     String?
  ipAddress  String?
  userAgent  String?
  viewedAt   DateTime @default(now())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User?    @relation("PropertyViews", fields: [userId], references: [id], onDelete: SetNull)

  @@index([propertyId, viewedAt])
  @@index([userId])
  @@map("property_views")
}

/// Rating dan review property oleh user yang sudah login.
model PropertyRating {
  id         String   @id @default(uuid())
  propertyId String
  userId     String
  rating     Int // 1-5 stars
  comment    String? // Optional review text
  ratedAt    DateTime @default(now())
  updatedAt  DateTime @updatedAt
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User     @relation("PropertyRatings", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId]) // One rating per user per property
  @@index([propertyId])
  @@index([userId])
  @@map("property_ratings")
}

/// Favorit property oleh user yang sudah login.
model PropertyFavorite {
  id           String              @id @default(uuid())
  propertyId   String
  userId       String
  collectionId String?
  favoritedAt  DateTime            @default(now())
  property     Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user         User                @relation("PropertyFavorites", fields: [userId], references: [id], onDelete: Cascade)
  collection   FavoriteCollection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)

  @@unique([propertyId, userId]) // One favorite per user per property
  @@index([propertyId])
  @@index([userId])
  @@index([userId, favoritedAt]) // For user's favorites list ordered by date
  @@index([collectionId])
  @@map("property_favorites")
}

/// Custom collections/wishlists created by users to organize their favorite properties.
model FavoriteCollection {
  id        String   @id @default(uuid())
  userId    String
  name      String // Collection name (max 20 chars enforced in app)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User               @relation("UserCollections", fields: [userId], references: [id], onDelete: Cascade)
  favorites PropertyFavorite[] // Properties in this collection

  @@index([userId])
  @@index([userId, createdAt]) // For user's collections list ordered by date
  @@map("favorite_collections")
}

/// Review dan rating property oleh tenant setelah menyelesaikan booking/lease.
/// Satu review per lease untuk memastikan hanya tenant yang benar-benar menginap yang bisa review.
model Review {
  id         String   @id @default(uuid())
  propertyId String
  userId     String
  leaseId    String   @unique // One review per lease
  rating     Int // 1-5 stars
  comment    String // Review text (minimum 10 characters enforced in app)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  property Property @relation("PropertyReviews", fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)
  lease    Lease    @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@index([propertyId, createdAt]) // For fetching property reviews ordered by date
  @@index([userId])
  @@index([rating]) // For filtering by rating
  @@map("reviews")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

/// Peran pengguna di sistem.
enum Role {
  USER
  ADMIN
}

/// Status listing untuk alur publikasi/approval.
enum ListingStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

/// Status approval per-riwayat keputusan admin.
enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

/// Status siklus kontrak sewa (simplified).
enum LeaseStatus {
  PENDING // User submit booking, tunggu review owner
  APPROVED // Owner setujui booking
  REJECTED // Owner tolak booking
  ACTIVE // Sewa sedang berlangsung (optional)
  COMPLETED // Sewa sudah selesai (optional)
  CANCELLED // Booking dibatalkan oleh user atau landlord
}

/// Jenis invoice/tagihan dalam sewa.
enum InvoiceType {
  RENT
  DEPOSIT
  UTILITY
  OTHER
}

/// Status invoice (penagihan).
enum InvoiceStatus {
  DUE
  PAID
  VOID
  REFUNDED
}

/// Metode pembayaran yang didukung.
enum PaymentMethod {
  BANK_TRANSFER
  CASH
  EWALLET
  CREDIT_CARD
}

/// Status transaksi pembayaran.
enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

/// Stripe payment tracking untuk mobile payment integration
model StripePayment {
  id              String    @id @default(uuid())
  bookingId       String // Lease ID (bookingId in mobile context)
  userId          String
  amount          Decimal   @db.Decimal(12, 2)
  currency        String    @default("myr")
  paymentIntentId String?   @unique
  status          String    @default("pending") // pending, processing, completed, failed, refunded, canceled, requires_action
  completedAt     DateTime?
  refundedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  booking Lease @relation("LeaseStripePayments", fields: [bookingId], references: [id], onDelete: Cascade)
  user    User  @relation("UserStripePayments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([userId])
  @@index([paymentIntentId])
  @@index([status])
  @@map("stripe_payments")
}
