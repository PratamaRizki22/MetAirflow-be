include:
  - template: SAST.gitlab-ci.yml
  - template: Secret-Detection.gitlab-ci.yml

image: node:20

stages:
  - install
  - validate
  - test
  - deploy

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - node_modules/
    - .pnpm-store/
  policy: pull-push

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'main' || $CI_COMMIT_BRANCH == 'staging'
    - if: $CI_PIPELINE_SOURCE == 'web'

# =========================
# INSTALL
# =========================
install_dependencies:
  stage: install
  script:
    - npm install -g pnpm
    - pnpm install --frozen-lockfile

# =========================
# VALIDATE
# =========================
validate_code:
  stage: validate
  needs: [install_dependencies]
  script:
    - npm install -g pnpm
    - pnpm run lint
    - pnpm run db:generate

# =========================
# TEST (opsional, contoh)
# =========================
test_app:
  stage: test
  needs: [install_dependencies]
  script:
    - npm install -g pnpm
    - pnpm run test || echo "No tests yet"

# =========================
# DEPLOY (PRODUCTION)
# =========================
deploy_production:
  stage: deploy
  image: alpine:latest
  needs:
    - validate_code
    - test_app
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  before_script:
    - apk add --no-cache openssh rsync
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -p $SSH_PORT $SSH_HOST >> ~/.ssh/known_hosts
  script:
    - rsync -avz --delete ./ $SSH_USER@$SSH_HOST:/home/$SSH_USER/apps/rentverse-backend
    - ssh $SSH_USER@$SSH_HOST "
      cd ~/apps/rentverse-backend &&
      docker compose down &&
      docker compose up -d --build
      "
