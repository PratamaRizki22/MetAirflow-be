name: Deploy Backend to Server

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate Secrets
        run: |
          if [ -z "$HOST" ]; then
            echo "❌ ERROR: HOST secret is not set!"
            exit 1
          fi
          if [ -z "$USERNAME" ]; then
            echo "❌ ERROR: USERNAME secret is not set!"
            exit 1
          fi
          if [ -z "$SSH_KEY" ]; then
            echo "❌ ERROR: SSH_KEY secret is not set!"
            exit 1
          fi
          echo "✅ All required secrets are set"
          echo "Server: $HOST"
          echo "User: $USERNAME"
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "Host target" >> ~/.ssh/config
          echo "  HostName $HOST" >> ~/.ssh/config
          echo "  User $USERNAME" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "✅ SSH config created successfully"
          cat ~/.ssh/config
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}

      - name: Deploy to Server
        run: |
          # Create target directory if not exists
          ssh target "mkdir -p rentverse-core-service"

          # Transfer files using tar over ssh (exclude node_modules, .git, .env)
          # We prefer tar over scp for speed and preserving permissions
          tar -czf - --exclude='.git' --exclude='node_modules' --exclude='.env' --exclude='.github' . | ssh target "tar -xzf - -C rentverse-core-service"

      - name: Setup Environment Variables
        run: |
          ssh target "cd rentverse-core-service && \
          if ! grep -q 'AI_SERVICE_URL' .env 2>/dev/null; then \
            echo 'AI_SERVICE_URL=http://rentverse-ai-service-rentverse-ai-1:8000' >> .env && \
            echo '✅ Added AI_SERVICE_URL to .env'; \
          else \
            echo '✅ AI_SERVICE_URL already exists in .env'; \
          fi"

      - name: Connect AI Service to Backend Network
        run: |
          ssh target "docker network connect rentverse-network rentverse-ai-service-rentverse-ai-1 2>&1 || echo '✅ AI service already connected to rentverse-network'"

      - name: Build and Restart All Services
        run: |
          ssh target "cd rentverse-core-service && \
          echo 'Building new image...' && \
          docker compose build app --no-cache && \
          echo 'Applying database schema...' && \
          docker compose run --rm app npx prisma db push --accept-data-loss && \
          echo 'Starting all services...' && \
          docker compose up -d && \
          echo 'Pruning old images...' && \
          docker image prune -f"
